<!DOCTYPE html>
<!--
Created using JS Bin
http://jsbin.com

Copyright (c) 2016 by devynglass (http://jsbin.com/dudusov/8/edit)

Released under the MIT license: http://jsbin.mit-license.org
-->
<meta name="robots" content="noindex">
<html>
<head>
<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.6/paper/bootstrap.min.css" rel="stylesheet" integrity="sha384-2mX2PSpkRSXLQzmNzH3gwK6srb06+OfbDlYjbog8LQuALYJjuQ3+Yzy2JIWNV9rW" crossorigin="anonymous">
  <title>Verify Page</title>
<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Verify Notarization</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, user-scalable = no">
<link rel="stylesheet" href="css/verify.css">
</head>
    <body>  
<h1 class="myH1">Verify Block Chain Notarization</h1>    
<div id="step1" class="wrapper1">
<h3 class="myH2">Step One</h3>
<p class="myP1">Upload Proof of Registration</p>
<input class= "input1" type="file" id="files" name="file"/><br/>
</div> 
<div id="step2" class="wrapper2">
<h3 class="myH3">Step Two</h3>
<p>Generate the Hash of Your Proof of Registration</p>
<button id="step2hash" class="getHash first">Calculate Hash</button><br /><br />
<label for="hash1">Documentation Hash:</label>
<input type="text" id="hash1" size="80" style="color:blue">
        </div> 
<div id="step3" class="wrapper3">
<h3 class="myH4">Step Three</h3>
<label for="checkRegister">Verify that Your Signed Document is Registered on Block 
Chain</label><br /><br />
<button id="checkRegister">Check Registration</button>
<div id="regResult"></div>
<div id="regUpshot"></div>
<div id="docHash"></div>
        </div>  
<div id= "step4" class="wrapper4">
<h3 class="myH5">Step Four</h3>
<p>Upload Original Document to Confirm that it Matches this Hash</p>
<input class="input2" type="file" id="files2" name="file2"/><br/>
<br /><button class="getHash second">Calculate Hash</button><br /><br />
<label for="hash2">Hash of Original Document:</label>
<input type="text" id="hash2" size="80" style="color:blue">
<div id="docHashUpshot"></div>
</div><br /><br />
     
<div class="home"><a href="http://output.jsbin.com/marifa" title="Home"><img src="http://findicons.com/files/icons/1580/devine_icons_part_2/128/home.png" width="45" alt="Home" style="z-index:999;position:fixed;top:100px;right:0px;"></a></div>
<script type="text/javascript" language="javascript">
x$(document).ready(function() {
if (x$("div.xg_widget_main_index_index").length > 0) {
x$('div.home').css('display','none');
}
});
</script>
      
<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/rollups/sha256.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.0.2/build/components/enc-base64-min.js"></script>
<script src="openpgp.js"></script>
<script src="verify.js"></script>
<script id="jsbin-javascript">
/* globals alert, CryptoJS, openpgp */
var sha256, receiptData, docHash, fingerprint, timestamp, tx;

function readBlob(opt_startByte, opt_stopByte, which) {
    var files;
    if (which === 'first'){
        files = document.getElementById('files').files;
    } else {
        files = document.getElementById('files2').files;
    }
    if (!files.length) {
        alert('Please select a file');
        return;
    }

    var file = files[0];
    var start = parseInt(opt_startByte) || 0;
    var stop = parseInt(opt_stopByte) || file.size - 1;

    var reader = new FileReader();

    // If we use onloadend, we need to check the readyState.
    reader.onloadend = function(evt) {
        if (evt.target.readyState === FileReader.DONE) { // DONE == 2
            if (which === 'first'){
                //We are only parsing JSON with the receipt, not document itself
                receiptData = JSON.parse(evt.target.result);
            }
            sha256.update(CryptoJS.enc.Latin1.parse(evt.target.result));
            var hash = sha256.finalize();
            if (which === 'first'){
                $('#hash1').val(hash);
            } else {
                $('#hash2').val(hash);
                if (hash.toString() === docHash.toString()){
                    fingerprint = receiptData.fingerprint;
                    //fingerprint = '01506206c29e82b0b8c6c3000cce0de605ac57b5';
                    $('#docHashUpshot').html('Yes, your uploaded document is the same one recorded in the blockchain');
                    //check to see if this was signed with keybase key
                    $.ajax('https://keybase.io/_/api/1.0/user/lookup.json?key_fingerprint=' + fingerprint)
                    .done(function(res){
                            if (res.them.length > 0){
                                console.log(res);
                                var username = res.them[0].basics.username;
                                var fullName = res.them[0].profile.full_name;
                                $('#docHashUpshot').append('This document was signed by' +
                                ' <a href="https://keybase.io/' + username + 
                                '">' + fullName + '</a>' + ' on ' + timestamp);
                            } else {
                                $('#docHashUpshot').append('<p>The document was signed by a key with the fingerprint ' + fingerprint);
                            }
                    
                    });
                } else {
                    $('#docHashUpshot').html('Sorry, your uploaded document is not the same one that is in the block chain.');
                }
            }
        }
    };

    var blob = file.slice(start, stop + 1);
    reader.readAsBinaryString(blob);
}

$('.getHash').on('click', function(e){
    var startByte = e.target.getAttribute('data-startbyte');
    var endByte = e.target.getAttribute('data-endbyte');
    sha256 = CryptoJS.algo.SHA256.create();
    if ($(this).hasClass('first')){
        readBlob(startByte, endByte, 'first');
    } else {
        readBlob(startByte, endByte, 'second');
    }
});

$('#checkRegister').on('click', function(){
    var data = $('#hash1').val();
    var settings = {
        'dataType': 'json',
        'url': 'https://loyolalawtech.org/json/btc-notary.php?d=' + data,
        'method': 'GET'
    };

    $.ajax(settings).done(function (response) {
       console.log(response);
       timestamp = response.timestamp;
       tx = response.tx;
       docHash = receiptData.signature.match(/([a-z0-9]){64}/g);
       if (response.success){
         $('#regUpshot').html('<b>Congrats. This hash is <a href="https://www.blocktrail.com/BTC/tx/' + tx + '">registered in the blockchain</a></b>');
            $('#docHash').html('The hash of the document you registered is ' + docHash);
         } else {
            $('#regUpshot').html('<b>Sorry. This hash is not registered in the blockchain');
         }
    });
});

$(document).ready(function () {

    $("#step2").hide();

    $("#files").click(function(){
         $("#step2").toggle();
    });
});

$(document).ready(function () {

    $("#step3").hide();

    $("#step2hash").click(function(){
         $("#step3").toggle();
    });
});

$(document).ready(function () {

     $("#step4").hide();

    $("#checkRegister").click(function(){
         $("#step4").toggle();
    });
});
</script>
</body>
</html>
